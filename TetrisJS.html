<!DOCTYPE HTML>
<html>
    <head>
        
        <style>
            #screen{
                background-color: black;
            }
        </style>



    </head>

    <body>
        <canvas id ="screen" width="300" height="600">
        </canvas>
            
        <script type = "text/javascript">
            var screen = document.getElementById("screen");
            var con = screen.getContext("2d") ;
            var BACKGROUNDCOLOR = "#c0c0c0";
            var oldtime = window.performance.now();
            var colors = [
                "#000000",
                "#ff0000",
                "#00ff00",
                "#0000ff",
                "#ffff00",
                "#00ffff",
                "#ff8800",
                "#0088ff"
            ]
            
            function getRandomInt(min, max) {
                min = Math.ceil(min);
                max = Math.floor(max);
                return Math.floor(Math.random() * (max - min) + min); //The maximum is exclusive and the minimum is inclusive
            }
            
            function newBlock() {
                updateable.pop();
                drawable.pop();
                block = new Block();
                updateable.push(block);
                drawable.push(block);
            }

            function rectBorder(block_Color, x, y, width, height) {
                con.beginPath();
                con.fillStyle = block_Color;
                con.fillRect(x, y, width, height);
                con.strokeStyle = BACKGROUNDCOLOR;
                con.lineWidth = 2;
                con.strokeRect(x, y, width, height);
                con.closePath();
            }
            
            class Map{

                constructor() {
                    this.map = [
                    [0,0,0,0,0,0,0,0,0,0],
                    [0,0,0,0,0,0,0,0,0,0],
                    [0,0,0,0,0,0,0,0,0,0],
                    [0,0,0,0,0,0,0,0,0,0],
                    [0,0,0,0,0,0,0,0,0,0],
                    [0,0,0,0,0,0,0,0,0,0],
                    [0,0,0,0,0,0,0,0,0,0],
                    [0,0,0,0,0,0,0,0,0,0],
                    [0,0,0,0,0,0,0,0,0,0],
                    [0,0,0,0,0,0,0,0,0,0],
                    [0,0,0,0,0,0,0,0,0,0],
                    [0,0,0,0,0,0,0,0,0,0],
                    [0,0,0,0,0,0,0,0,0,0],
                    [0,0,0,0,0,0,0,0,0,0],
                    [0,0,0,0,0,0,0,0,0,0],
                    [0,0,0,0,0,0,0,0,0,0],
                    [0,0,0,0,0,0,0,0,0,0],
                    [0,0,0,0,0,0,0,0,0,0],
                    [0,0,0,0,0,0,0,0,0,0],
                    [0,0,0,0,0,0,0,0,0,0]
                    ];
                    
                    this.size = 30;
                    this.listener = null;   
                }
                
                isFilled(x,y) {
                    if (this.map.length <= y) { return true }
                    if (x < 0 || this.map[1].length <= x ) { return true; }
                    if (y < 0) { return false; }
                    return this.map[y][x] != 0;
                }
                
                isLineFilled(y) {
                    for (var x = 0; x <= this.map[y].length; x++) {
                        if (!map.isFilled(x,y)) { return false; }
                    }
                    return true;
                }

                
                update(dt) {
                    var dropped = 0;
                    for (var y = 0; y < 20; y++) {    
                        if (this.isLineFilled(y)) {
                            dropped += 1;
                            for (var i = y; i > 1; i--) { this.map[i] = this.map[i-1]; }
                            this.map[0] = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0];  
                        }
                    }
                }
                
                draw() {
                    for(var y = 0; y < this.map.length; y++){
                        for (var x = 0; x < this.map[y].length; x++) {
                            rectBorder(colors[this.map[y][x]], x*this.size, y*this.size, this.size, this.size);
                        }
                    }
                }
            }
            
            //=================================================
            
            class Score {
                
                constructor () {
                    this.speed = 200;
                    this.points = 0;
                    this.fastSpeed = null;
                    this.numLines = 0;
                }
                
                
                
            }
            
            //=================================================
    
            class Block {
                
                constructor () {
                    this.x = 5;
                    this.y = 0;
                    this.dx = [];
                    this.dy = [];
                    this.color = getRandomInt(1,8);
                    this.formation();
                }
                
                static dtotal = 0;
                
                draw () {
                    for (var i = 0; i < 4; i++) {
                        rectBorder(colors[this.color], this.getX(i)*map.size, this.getY(i)*map.size, map.size, map.size);
                    }
                }
                
                getX(i) { return this.x + this.dx[i]; }
                getY(i) { return this.y + this.dy[i]; }
                left() { this.x = this.x - 1; }
                right() { this.x = this.x + 1; }
                
                clockwise() {
                    for(var i = 1; i < 4; i++) {
                        var dx = this.dx[i];
                        this.dx[i] = -this.dy[i];
                        this.dy[i] = dx;
                    }
                    this.checkBounds();
                }
                
                counterClock() {
                    for(var i = 1; i < 4; i++) {
                        var dx = this.dx[i];
                        this.dx[i] = this.dy[i];
                        this.dy[i] = -dx;
                    }
                    this.checkBounds();
                }
                
                onClockwise() {
                    this.clockwise();
                    for (var i = 0; i < 4; i++) {
                        var y = this.getY(i), x = this.getX(i) - 1;
                        if (map.isFilled(x,y)) {
                            this.counterClock();
                            return
                        }
                    }
                }
                
                onCounterClock() {
                    this.counterClock();
                    for (var i = 0; i < 4; i++) {
                        var y = this.getY(i), x = this.getX(i) - 1;
                        if (map.isFilled(x,y)) {
                            this.clockwise();
                            return;
                        }
                    }
                }
                
                onLeft() {
                    for (var i = 0; i < 4; i++) {
                        var y = this.getY(i), x = this.getX(i) - 1;
                        if (map.isFilled(x,y)) {
                            return
                        }
                    }
                    this.left()
                }
                
                onRight() {
                    for (var i = 1; i < 4; i++) { 
                        var y = this.getY(i), x = this.getX(i) + 1;
                        if (map.isFilled(x,y)) {
                        return
                        }
                    }
                    this.right()
                }

                checkBounds () {
                    var xmin = Math.min(...this.dx) + this.x;
                    var xmax = Math.max(...this.dx) + this.x - 9;
                    if (xmin < 0) { this.x -= xmin }
                    if (xmax > 0) { this.x -= xmax }
                }
                
                update(dt) {
                    Block.dtotal = Block.dtotal + dt;
                    var timeLimit = score.speed;
                    if (Block.dtotal >= timeLimit) {
                        if (!this.collision()) {
                            this.y = Math.min(19, this.y + 1);
                            Block.dtotal = 0;
                            return;
                        }
                        Block.dtotal = 0;
                     
                        if (this.collision()) {
                           this.setBlock();
                        }
                    }
                }
                
                setBlock() {
                    for (var i = 0; i < 4; i++) {
                        var y = this.getY(i), x = this.getX(i)
                        if ( -1 < y && y <= map.map.length ) {
                            if ( !map.isFilled(x, y) ) {
                                map.map[y][x] = this.color
                            }
                        }
                        if (y < -1) {
                            return 'gameOver';
                        } else { newBlock(); }
                    }
                }
                
                collision() {
                    for (var i = 0; i < 4; i++) {
                        if (this.getY(i) >= 19) {
                            return true;
                        }
                    }
                    for (var i = 0; i < 4; i++) {
                        var y = this.getY(i), x = this.getX(i);
                        if (map.isFilled(x,y+1) || map.isFilled(x,y)) {
                            return true;
                        }
                    }
                }
                
                formation () {
                    if ( this.color == 1) {
                        this.dx = [0,-1,0,1];
                        this.dy = [0,0,-1,-1];
                    }
                    if ( this.color == 2) {
                        this.dx = [0,-1,0,1];
                        this.dy = [0,-1,-1,0];
                    }
                    if ( this.color == 3) {
                        this.dx = [0,-1,0,0];
                        this.dy = [0,0,-1,-2];
                    }
                    if ( this.color == 4) {
                        this.dx = [0,1,0,1];
                        this.dy = [0,0,-1,-1];
                    }
                    if ( this.color == 5) {
                        this.dx = [0,-1,1,0];
                        this.dy = [0,0,0,-1];
                    }
                    if ( this.color == 6) {
                        this.dx = [0,1,0,0];
                        this.dy = [0,0,-1,-2];
                    }
                    if ( this.color == 7) {
                        this.dx = [0,0,0,0];
                        this.dy = [0,-1,-2,-3];
                    }
                }
            }
            
            //=================================================
            
            var buttonOptions = {
                'ArrowLeft'  : function() { block.onLeft();},
                'ArrowRight' : function() { block.onRight();},
                ' '          : function() { block.onDrop(); },
                'ArrowUp'    : function() { block.onCounterClock(); },
                'ArrowDown'  : function() { block.onClockwise(); },
                //'ArrowUp'    : function() { block.clockwise(); },
                //'ArrowDown'  : function() { block.counterClock(); },
                'Shift'      : function() { score.fastSpeed = .07; }
            }
            
            //=================================================
            
            var updateable = [];
            var drawable = [];
            
            //=================================================
            
            function keypressed(event) {
                var key = event.key;
                var action = buttonOptions[key];
                if (action) { action(); }
            }
            
            //=================================================
            
            function update() {
                var time = window.performance.now();
                var dt = time - oldtime;
                oldtime = time;
                for (var j = 0; j < updateable.length; j++) { updateable[j].update(dt); }
                
            }
            
            //=================================================
            
            function draw () {
                update();
                for (var i = 0; i < drawable.length; i++) {   
                    drawable[i].draw();
                }
            }
            
            //=================================================
            var score = new Score();
            var map = new Map();
            var block = new Block();
            
            document.addEventListener("keydown", keypressed);
            
            //=================================================
            
            updateable.push(map);
            drawable.push(map);
            
            updateable.push(block);
            drawable.push(block);
            
            setInterval(draw,1);
            
        </script>

    </body>


</html>



